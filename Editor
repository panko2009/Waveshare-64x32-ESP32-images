import tkinter as tk
from tkinter import colorchooser, simpledialog
import time

WIDTH = 64
HEIGHT = 32
CELL_SIZE = 15

class LEDDesigner:
    def __init__(self, root):
        self.root = root
        self.root.title("LED Animation Designer (64x32)")
        self.canvas = tk.Canvas(root, width=WIDTH*CELL_SIZE, height=(HEIGHT+1)*CELL_SIZE, bg="black")
        self.canvas.pack()

        self.frames = []
        self.current_frame = [["#000000" for _ in range(WIDTH)] for _ in range(HEIGHT)]
        self.frames.append([row[:] for row in self.current_frame])

        self.selected_color = "#FFFFFF"
        self.history = []
        self.future = []
        self.frame_duration = 500

        self.canvas.bind("<Button-1>", self.paint_pixel)
        self.canvas.bind("<B1-Motion>", self.paint_pixel)
        self.canvas.bind("<ButtonRelease-1>", self.release_mouse)
        self.root.bind("<Control-z>", self.ctrl_z)

        control_frame = tk.Frame(root)
        control_frame.pack(pady=5)

        self.color_entry = tk.Entry(control_frame, width=10)
        self.color_entry.insert(0, self.selected_color)
        self.color_entry.pack(side=tk.LEFT, padx=2)

        tk.Button(control_frame, text="Pick Color", command=self.pick_color).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Undo", command=self.undo).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Redo", command=self.redo).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Eraser", command=self.activate_eraser).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Add Frame", command=self.add_frame).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Preview", command=self.preview_animation).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Export Code", command=self.export_code).pack(side=tk.LEFT, padx=2)

        self.rects = [[None for _ in range(WIDTH)] for _ in range(HEIGHT)]

        for x in range(WIDTH):
            x1 = x * CELL_SIZE
            color = self.get_ruler_color(x)
            self.canvas.create_rectangle(x1, 0, x1 + CELL_SIZE, CELL_SIZE, fill=color, outline=color)

        for y in range(HEIGHT):
            for x in range(WIDTH):
                x1, y1 = x * CELL_SIZE, (y + 1) * CELL_SIZE
                rect = self.canvas.create_rectangle(x1, y1, x1 + CELL_SIZE, y1 + CELL_SIZE, fill="black", outline="#222")
                self.rects[y][x] = rect

    def get_ruler_color(self, x):
        if x < 2 or x >= WIDTH - 2:
            return "red"
        segment = x - 2
        block_index = segment // 4
        return "green" if block_index % 2 == 0 else "red"

    def paint_pixel(self, event):
        x, y = event.x // CELL_SIZE, (event.y - CELL_SIZE) // CELL_SIZE
        if 0 <= x < WIDTH and 0 <= y < HEIGHT:
            prev_color = self.current_frame[y][x]
            new_color = self.selected_color
            if prev_color != new_color:
                self.history.append((x, y, prev_color))
                self.current_frame[y][x] = new_color
                self.canvas.itemconfig(self.rects[y][x], fill=new_color)
                self.future.clear()
                self.frames[-1][y][x] = new_color

    def release_mouse(self, event):
        pass

    def set_color_from_entry(self):
        color = self.color_entry.get().strip()
        if color.startswith('#') and len(color) == 7:
            self.selected_color = color.upper()
        else:
            print("Invalid hex color. Use format #RRGGBB")

    def pick_color(self):
        color = colorchooser.askcolor(title="Choose color", initialcolor=self.selected_color)[1]
        if color:
            self.selected_color = color
            self.color_entry.delete(0, tk.END)
            self.color_entry.insert(0, color)

    def activate_eraser(self):
        self.selected_color = "#000000"
        self.color_entry.delete(0, tk.END)
        self.color_entry.insert(0, "#000000")

    def undo(self):
        if self.history:
            x, y, prev_color = self.history.pop()
            current_color = self.current_frame[y][x]
            self.current_frame[y][x] = prev_color
            self.canvas.itemconfig(self.rects[y][x], fill=prev_color)
            self.future.append((x, y, current_color))
            self.frames[-1][y][x] = prev_color

    def ctrl_z(self, event):
        self.undo()

    def redo(self):
        if self.future:
            x, y, redo_color = self.future.pop()
            prev_color = self.current_frame[y][x]
            self.current_frame[y][x] = redo_color
            self.canvas.itemconfig(self.rects[y][x], fill=redo_color)
            self.history.append((x, y, prev_color))
            self.frames[-1][y][x] = redo_color

    def add_frame(self):
        self.frames.append([row[:] for row in self.current_frame])
        self.history.clear()
        self.future.clear()
        print(f"Added frame {len(self.frames)}")

    def preview_animation(self):
        try:
            duration = int(simpledialog.askstring("Frame Duration (ms)", "Enter duration per frame in milliseconds:"))
            if duration <= 0:
                raise ValueError
            self.frame_duration = duration
        except:
            print("Invalid duration. Using default 500ms.")
            self.frame_duration = 500

        for frame in self.frames:
            for y in range(HEIGHT):
                for x in range(WIDTH):
                    self.canvas.itemconfig(self.rects[y][x], fill=frame[y][x])
            self.root.update()
            time.sleep(self.frame_duration / 1000.0)

    def export_code(self):
        result = "\n// === COPY THIS INTO YOUR ESP IDE ===\n"
        for y in range(HEIGHT):
            for x in range(WIDTH):
                color = self.current_frame[y][x]
                if color != "#000000":
                    r = int(color[1:3], 16)
                    b = int(color[3:5], 16)
                    g = int(color[5:7], 16)
                    result += f"  matrix->drawPixelRGB888({x}, {y}, {r}, {g}, {b});\n"
        result += "}\n"

        preview_window = tk.Toplevel(self.root)
        preview_window.title("Exported Code")
        text_box = tk.Text(preview_window, wrap=tk.NONE)
        text_box.insert(tk.END, result)
        text_box.pack(expand=True, fill="both")


if __name__ == "__main__":
    root = tk.Tk()
    app = LEDDesigner(root)
    root.mainloop()
